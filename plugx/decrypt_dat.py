import sys 

def xor_decrypt(key, data):
     
    sz = len(data) - (len(key) + 1)
    result = bytearray(sz)
    
    for i in range(0, sz):
        result[i] = (data[i + len(key) + 1] ^ key[i % len(key)])
    
    return result 
    
def main():

    filename = sys.argv[1]
    with open(filename, "rb") as f:
        data = f.read()
        f.close()
        
    key = data.split(b"\00")[0]
    result = xor_decrypt(key, data)

    if result.startswith(b"MZ"):
        with open("decrypted_dat.bin", "wb") as f:
            f.write(result)
            f.close()
    else:
        print("[+] The decrypted result is not a PE file")
    
if __name__ == "__main__":
    main()
