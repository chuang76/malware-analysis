import sys
import pefile

def get_text_section(pe):

    start, size = 0, 0

    for section in pe.sections:
        if section.Name.decode('utf-8').startswith('.text'):
            start = pe.get_offset_from_rva(section.VirtualAddress)
            size = section.SizeOfRawData 

    return (start, size)


def main():

    if len(sys.argv) != 2:
        print("[-] Usage: patch.py <path\\to\\file>")

    else:
        filename = sys.argv[1]
        with open(filename, "rb") as f:
            buf = f.read()
            f.close()
        
        pe = pefile.PE(data=buf)
        start, size = get_text_section(pe)

        # replace "int 3; ret" with "call eax"
        patched_text_section = buf[start:start+size].replace(b"\xCC\xC3", b"\xFF\xD0")
        patched_buf = buf[:start] + patched_text_section + buf[start+size:]

        with open(filename + "_patched.bin", "wb") as f:
            f.write(patched_buf)
            f.close()
            

if __name__ == "__main__":
    main()
